# NIO 

NIO 三要素： Selector, Channel, Buffer。

## IO 流

流按照处理数据类型的不同，分为**字符流**（reader, writer）和**字节流**（InputStream, OutputStream）。但是底层数据传输还是依赖字节流，字符流只是对字节流进行了一次编解码的包装而已。

> 一般来说， Stream 结尾的类都是字节流， er 结尾的类都是字符流

另外，也可以按照功能分为**节点流**和**处理流**。直接建立于操作对象（文件）进行操作的是节点流，而处理流是建立于节点流上操作的，如 Buffer 缓存，减少 IO 次数。

## JAVA 一次普通 IO 操作经历了什么

1. 用户进程使用 read() 系统调用，要求用户空间的缓冲区填满；
2. 内核像磁盘控制器硬件发送命令，要求从磁盘读入数据；
3. 磁盘控制器以 DMA 方式（不需要 CPU）把数据复制到内核缓冲区；
4. 内核将数据从内核缓冲区复制于用户进程发起 read() 调用时指定的内存空间。

其中，数据经过了两次拷贝🙁：硬件 -> 内核空间 -> 用户空间，用户态和内核态的上下文切换增加了 CPU 负担。另外，用户进程需要一直等待🙁直至数据的返回。

## NIO 对普通 IO 的优化

## ZERO COPY

零拷贝避免了数据从一块存储拷贝到另外一块存储。

* 不需要内核提供 Page Cache。Direct IO，硬件 -> 用户空间。
* 不需要应用程序用户态处理，mmap（`MappedByteBuffer`）, sendfile()（`FileChannel`）, splice(), 硬件 -> 内核空间。
* COW，写时复制

NIO 主要使用 Channel 和 Buffer 实现了第二点。Channel 直接连通了 IO 源，是一条快速通道，Buffer 则作为一个数据载体在其中搬运数据。

## 非阻塞

Selector，事件机制，一个进程管理多个 Channel。类似观察者模式。